<!-- templates/admin/scraper_dashboard.html - Version compl√®te avec logs temps r√©el -->
{% extends "base.html" %}

{% block title %}Administration Scraping - LinkedBoost{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>
                <i class="fas fa-robot me-2 text-primary"></i>Administration du Scraping
            </h2>
            <div>
                <button class="btn btn-success" onclick="startScraping()">
                    <i class="fas fa-play me-2"></i>Lancer le scraping
                </button>
                <button class="btn btn-info ms-2" onclick="refreshStats()">
                    <i class="fas fa-sync me-2"></i>Actualiser
                </button>
            </div>
        </div>
    </div>

    <!-- Statistiques globales -->
    <div class="col-12 mb-4">
        <div class="row g-3">
            <div class="col-md-3">
                <div class="card bg-primary text-white">
                    <div class="card-body text-center">
                        <i class="fas fa-briefcase fa-2x mb-2"></i>
                        <h4 id="totalJobs">-</h4>
                        <small>Offres totales</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-success text-white">
                    <div class="card-body text-center">
                        <i class="fas fa-clock fa-2x mb-2"></i>
                        <h4 id="lastScrape">-</h4>
                        <small>Dernier scraping</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-info text-white">
                    <div class="card-body text-center">
                        <i class="fas fa-database fa-2x mb-2"></i>
                        <h4 id="embeddingsCount">-</h4>
                        <small>Embeddings</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-warning text-white">
                    <div class="card-body text-center">
                        <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                        <h4 id="errorCount">-</h4>
                        <small>Erreurs</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Configuration du scraping -->
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-cog me-2"></i>Configuration du Scraping
                </h5>
            </div>
            <div class="card-body">
                <form id="scrapingConfigForm">
                    <div class="mb-3">
                        <label class="form-label">Sources √† scraper</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="wttj" checked>
                            <label class="form-check-label" for="wttj">
                                Welcome to the Jungle
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="linkedin" disabled>
                            <label class="form-check-label" for="linkedin">
                                LinkedIn (Bient√¥t disponible)
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="indeed" disabled>
                            <label class="form-check-label" for="indeed">
                                Indeed (Bient√¥t disponible)
                            </label>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="maxJobs" class="form-label">Nombre max d'offres par scraping</label>
                        <input type="number" class="form-control" id="maxJobs" value="100" min="10" max="500">
                    </div>

                    <div class="mb-3">
                        <label for="delay" class="form-label">D√©lai entre requ√™tes (secondes)</label>
                        <input type="number" class="form-control" id="delay" value="2" min="1" max="10" step="0.5">
                    </div>

                    <button type="button" class="btn btn-primary" onclick="saveConfig()">
                        <i class="fas fa-save me-2"></i>Sauvegarder la configuration
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Statut des scrapers -->
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-server me-2"></i>Statut des Scrapers
                </h5>
            </div>
            <div class="card-body">
                <div id="scrapersStatus">
                    <!-- Dynamiquement rempli -->
                </div>
            </div>
        </div>
    </div>

    <!-- Logs de scraping -->
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-list me-2"></i>Logs de Scraping
                </h5>
                <button class="btn btn-sm btn-outline-secondary" onclick="clearLogs()">
                    <i class="fas fa-trash me-1"></i>Effacer
                </button>
            </div>
            <div class="card-body">
                <div id="scrapingLogs" style="height: 300px; overflow-y: auto; background: #f8f9fa; padding: 1rem; border-radius: 0.375rem;">
                    <p class="text-muted">Aucun log disponible</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Analyse des donn√©es -->
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-bar me-2"></i>Analyse des Donn√©es Collect√©es
                </h5>
            </div>
            <div class="card-body">
                <div class="row g-4">
                    <div class="col-md-6">
                        <h6>Top Technologies</h6>
                        <div id="topTechnologies">
                            <!-- Dynamiquement rempli -->
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6>Distribution des Niveaux</h6>
                        <div id="experienceLevels">
                            <!-- Dynamiquement rempli -->
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6>Top Entreprises</h6>
                        <div id="topCompanies">
                            <!-- Dynamiquement rempli -->
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6>R√©partition Remote</h6>
                        <div id="remoteStats">
                            <!-- Dynamiquement rempli -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de progression avec logs temps r√©el -->
<div class="modal fade" id="scrapingProgressModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-robot me-2"></i>Scraping en cours
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" id="closeModalBtn" style="display: none;"></button>
            </div>
            <div class="modal-body">
                <!-- Progression globale -->
                <div class="mb-4">
                    <div class="d-flex justify-content-between mb-2">
                        <span id="currentPhase">Initialisation...</span>
                        <span id="progressText">0%</span>
                    </div>
                    <div class="progress mb-2">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" style="width: 0%" id="progressBar"></div>
                    </div>
                    <div class="row text-center">
                        <div class="col-3">
                            <small class="text-muted">Sources</small>
                            <div id="sourcesProgress">0/0</div>
                        </div>
                        <div class="col-3">
                            <small class="text-muted">Offres</small>
                            <div id="jobsProgress">0</div>
                        </div>
                        <div class="col-3">
                            <small class="text-muted">Erreurs</small>
                            <div id="errorsProgress">0</div>
                        </div>
                        <div class="col-3">
                            <small class="text-muted">Dur√©e</small>
                            <div id="durationProgress">0s</div>
                        </div>
                    </div>
                </div>

                <!-- D√©tails de progression -->
                <div class="mb-3" id="currentDetails" style="display: none;">
                    <div class="alert alert-info">
                        <div class="row">
                            <div class="col-6">
                                <strong>Source actuelle:</strong>
                                <div id="currentSource">-</div>
                            </div>
                            <div class="col-6">
                                <strong>Offre en cours:</strong>
                                <div id="currentJob">-</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Logs en temps r√©el -->
                <div class="mb-3">
                    <h6>Logs en temps r√©el</h6>
                    <div id="realTimeLogs" style="height: 250px; overflow-y: auto; background: #f8f9fa; padding: 1rem; border-radius: 0.375rem; font-family: monospace; font-size: 0.9rem;">
                        <div class="text-muted">En attente du d√©marrage...</div>
                    </div>
                </div>

                <!-- Actions -->
                <div class="text-center" id="modalActions">
                    <button class="btn btn-secondary" onclick="stopScraping()" id="stopBtn">
                        <i class="fas fa-stop me-2"></i>Arr√™ter
                    </button>
                </div>
            </div>
            <div class="modal-footer" id="modalFooter" style="display: none;">
                <button type="button" class="btn btn-success" data-bs-dismiss="modal">
                    <i class="fas fa-check me-2"></i>Termin√©
                </button>
                <button type="button" class="btn btn-primary" onclick="refreshStats()">
                    <i class="fas fa-sync me-2"></i>Actualiser les stats
                </button>
            </div>
        </div>
    </div>
</div>

<!-- CSS pour les logs -->
<style>
.log-entry {
    margin-bottom: 4px;
    padding: 2px 0;
    display: flex;
    align-items: center;
    gap: 8px;
}

.log-timestamp {
    color: #6c757d;
    font-size: 0.8em;
    min-width: 80px;
}

.log-icon {
    min-width: 20px;
    text-align: center;
}

.log-message {
    flex: 1;
}

.log-success .log-message {
    color: #198754;
}

.log-error .log-message {
    color: #dc3545;
}

.log-warning .log-message {
    color: #fd7e14;
}

.log-info .log-message {
    color: #0d6efd;
}

.log-debug .log-message {
    color: #6c757d;
    font-style: italic;
}
</style>
{% endblock %}

{% block scripts %}
<!-- Socket.IO pour les logs temps r√©el (optionnel) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>

<script>
let scrapingSocket = null;
let currentScrapingSession = null;
let scrapingInProgress = false;
let scrapingStartTime = null;

document.addEventListener('DOMContentLoaded', function() {
    loadStats();
    loadMarketAnalytics();
    initializeWebSocket();
});

function initializeWebSocket() {
    /**
     * Initialise la connexion WebSocket pour les logs temps r√©el
     * Note: N√©cessite l'impl√©mentation c√¥t√© serveur avec Flask-SocketIO
     */
    try {
        scrapingSocket = io('/scraping');
        
        scrapingSocket.on('connect', function() {
            console.log('üîå WebSocket connect√© pour scraping');
        });
        
        scrapingSocket.on('session_started', function(data) {
            console.log('üì° Session de scraping d√©marr√©e:', data.session_id);
            currentScrapingSession = data.session_id;
        });
        
        scrapingSocket.on('scraping_progress', function(data) {
            updateProgressDisplay(data);
        });
        
        scrapingSocket.on('scraping_log', function(data) {
            addRealTimeLog(data);
        });
        
        scrapingSocket.on('scraping_completed', function(data) {
            onScrapingCompleted(data);
        });
        
        scrapingSocket.on('disconnect', function() {
            console.log('üîå WebSocket d√©connect√©');
        });
    } catch (error) {
        console.log('‚ö†Ô∏è WebSocket non disponible, utilisation du mode standard');
    }
}

async function startScraping() {
    const sources = [];
    if (document.getElementById('wttj').checked) sources.push('wttj');
    if (document.getElementById('linkedin').checked) sources.push('linkedin');
    if (document.getElementById('indeed').checked) sources.push('indeed');
    
    if (sources.length === 0) {
        alert('Veuillez s√©lectionner au moins une source');
        return;
    }
    
    try {
        // Initialiser la session WebSocket si disponible
        if (scrapingSocket && scrapingSocket.connected) {
            scrapingSocket.emit('start_scraping_session', {sources: sources});
        }
        
        // Afficher modal de progression
        const modal = new bootstrap.Modal(document.getElementById('scrapingProgressModal'));
        modal.show();
        
        scrapingInProgress = true;
        scrapingStartTime = Date.now();
        resetProgressDisplay();
        
        addRealTimeLog({
            timestamp: new Date().toLocaleTimeString(),
            level: 'info',
            message: 'üöÄ D√©marrage du scraping...'
        });
        
        // Simulation de progression si pas de WebSocket
        if (!scrapingSocket || !scrapingSocket.connected) {
            simulateProgress();
        }
        
        const response = await fetch('/api/scraping/start', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                sources: sources,
                max_jobs: parseInt(document.getElementById('maxJobs').value),
                delay: parseFloat(document.getElementById('delay').value),
                session_id: currentScrapingSession
            })
        });
        
        const result = await response.json();
        
        scrapingInProgress = false;
        
        if (result.success) {
            addRealTimeLog({
                timestamp: new Date().toLocaleTimeString(),
                level: 'success',
                message: `‚úÖ Scraping termin√© : ${result.stats.total_jobs} offres collect√©es`
            });
            
            finalizeScraping(result.stats);
        } else {
            addRealTimeLog({
                timestamp: new Date().toLocaleTimeString(),
                level: 'error',
                message: `‚ùå Erreur scraping : ${result.error}`
            });
            finalizeScraping();
        }
        
    } catch (error) {
        scrapingInProgress = false;
        addRealTimeLog({
            timestamp: new Date().toLocaleTimeString(),
            level: 'error',
            message: `‚ùå Erreur : ${error.message}`
        });
        finalizeScraping();
    }
}

function simulateProgress() {
    /**
     * Simulation de progression si WebSocket indisponible
     */
    let progress = 0;
    const interval = setInterval(() => {
        if (!scrapingInProgress) {
            clearInterval(interval);
            return;
        }
        
        progress += Math.random() * 10;
        if (progress > 95) progress = 95;
        
        updateProgressDisplay({
            phase: 'Collecte des offres...',
            progress_percent: Math.round(progress),
            completed_sources: progress > 50 ? 1 : 0,
            total_sources: 1,
            total_jobs: Math.round(progress * 2),
            errors_count: 0,
            duration: Math.round((Date.now() - scrapingStartTime) / 1000)
        });
        
        // Logs simul√©s
        if (Math.random() > 0.7) {
            const messages = [
                'üîç Analyse de la page...',
                'üìÑ Extraction des offres...',
                '‚ú® Traitement des donn√©es...',
                'üíæ Sauvegarde en cours...'
            ];
            
            addRealTimeLog({
                timestamp: new Date().toLocaleTimeString(),
                level: 'info',
                message: messages[Math.floor(Math.random() * messages.length)]
            });
        }
    }, 1000);
}

function updateProgressDisplay(data) {
    /**
     * Met √† jour l'affichage de progression
     */
    // Phase actuelle
    document.getElementById('currentPhase').textContent = data.phase || 'En cours...';
    
    // Barre de progression
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const percent = Math.min(100, Math.max(0, data.progress_percent || 0));
    
    progressBar.style.width = percent + '%';
    progressText.textContent = percent + '%';
    
    // Statistiques
    document.getElementById('sourcesProgress').textContent = 
        `${data.completed_sources || 0}/${data.total_sources || 1}`;
    document.getElementById('jobsProgress').textContent = data.total_jobs || 0;
    document.getElementById('errorsProgress').textContent = data.errors_count || 0;
    document.getElementById('durationProgress').textContent = (data.duration || 0) + 's';
    
    // D√©tails actuels
    if (data.current_source || data.current_job) {
        document.getElementById('currentDetails').style.display = 'block';
        document.getElementById('currentSource').textContent = data.current_source || '-';
        document.getElementById('currentJob').textContent = data.current_job || '-';
    }
    
    // Changement de couleur selon progression
    if (percent >= 100) {
        progressBar.className = 'progress-bar bg-success';
    } else if ((data.errors_count || 0) > 0) {
        progressBar.className = 'progress-bar bg-warning progress-bar-striped progress-bar-animated';
    } else {
        progressBar.className = 'progress-bar bg-primary progress-bar-striped progress-bar-animated';
    }
}

function addRealTimeLog(logData) {
    /**
     * Ajoute un log en temps r√©el
     */
    const logsContainer = document.getElementById('realTimeLogs');
    
    // Ic√¥ne selon le niveau
    const icons = {
        'info': 'üîµ',
        'success': '‚úÖ',
        'warning': '‚ö†Ô∏è',
        'error': '‚ùå',
        'debug': 'üîç'
    };
    
    const icon = icons[logData.level] || 'üìÑ';
    
    // Cr√©er l'√©l√©ment de log
    const logElement = document.createElement('div');
    logElement.className = `log-entry log-${logData.level}`;
    logElement.innerHTML = `
        <span class="log-timestamp">[${logData.timestamp}]</span>
        <span class="log-icon">${icon}</span>
        <span class="log-message">${logData.message}</span>
    `;
    
    // Ajouter au container
    logsContainer.appendChild(logElement);
    
    // Scroll automatique vers le bas
    logsContainer.scrollTop = logsContainer.scrollHeight;
    
    // Limiter le nombre de logs affich√©s (garder les 100 derniers)
    const logEntries = logsContainer.querySelectorAll('.log-entry');
    if (logEntries.length > 100) {
        logEntries[0].remove();
    }
}

function resetProgressDisplay() {
    /**
     * Remet √† z√©ro l'affichage de progression
     */
    document.getElementById('currentPhase').textContent = 'Initialisation...';
    document.getElementById('progressBar').style.width = '0%';
    document.getElementById('progressText').textContent = '0%';
    document.getElementById('sourcesProgress').textContent = '0/0';
    document.getElementById('jobsProgress').textContent = '0';
    document.getElementById('errorsProgress').textContent = '0';
    document.getElementById('durationProgress').textContent = '0s';
    document.getElementById('currentDetails').style.display = 'none';
    document.getElementById('modalActions').style.display = 'block';
    document.getElementById('modalFooter').style.display = 'none';
    document.getElementById('closeModalBtn').style.display = 'none';
    document.getElementById('realTimeLogs').innerHTML = '<div class="text-muted">En attente du d√©marrage...</div>';
}

function finalizeScraping(stats = null) {
    /**
     * Finalise l'affichage apr√®s scraping
     */
    // Mettre √† jour la progression √† 100%
    updateProgressDisplay({
        phase: 'Termin√©',
        progress_percent: 100,
        completed_sources: 1,
        total_sources: 1,
        total_jobs: stats?.total_jobs || 0,
        errors_count: stats?.errors?.length || 0,
        duration: Math.round((Date.now() - scrapingStartTime) / 1000)
    });
    
    // Afficher boutons de fin
    document.getElementById('modalActions').style.display = 'none';
    document.getElementById('modalFooter').style.display = 'block';
    document.getElementById('closeModalBtn').style.display = 'block';
    
    // Recharger les stats
    loadStats();
    loadMarketAnalytics();
}

function stopScraping() {
    /**
     * Arr√™te le scraping en cours
     */
    if (scrapingInProgress && currentScrapingSession) {
        addRealTimeLog({
            timestamp: new Date().toLocaleTimeString(),
            level: 'warning',
            message: '‚èπÔ∏è Arr√™t du scraping demand√©...'
        });
        
        // Envoyer signal d'arr√™t via WebSocket si disponible
        if (scrapingSocket && scrapingSocket.connected) {
            scrapingSocket.emit('stop_scraping', {session_id: currentScrapingSession});
        }
        
        scrapingInProgress = false;
        
        // D√©sactiver le bouton d'arr√™t
        document.getElementById('stopBtn').disabled = true;
        document.getElementById('stopBtn').innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Annulation...';
    }
}

function onScrapingCompleted(data) {
    /**
     * Callback quand le scraping est termin√© (via WebSocket)
     */
    addRealTimeLog({
        timestamp: new Date().toLocaleTimeString(),
        level: 'success',
        message: `üéâ Scraping termin√© avec succ√®s`
    });
    
    finalizeScraping(data.stats);
}

// Fonctions pour les statistiques et analytics
async function loadStats() {
    try {
        const response = await fetch('/api/status');
        const data = await response.json();
        
        // Mise √† jour des statistiques principales
        document.getElementById('totalJobs').textContent = 
            data.features?.total_jobs || '0';
        
        // Format de la derni√®re date de scraping
        if (data.features?.last_scrape) {
            const date = new Date(data.features.last_scrape);
            document.getElementById('lastScrape').textContent = 
                date.toLocaleDateString('fr-FR');
        } else {
            document.getElementById('lastScrape').textContent = 'Jamais';
        }
        
        // Nombre d'embeddings
        document.getElementById('embeddingsCount').textContent = 
            data.features?.embedding_stats?.total_jobs || '0';
        
        // Nombre d'erreurs (fictif pour l'instant)
        document.getElementById('errorCount').textContent = '0';
        
        // Mise √† jour du statut des scrapers
        updateScrapersStatus(data);
        
    } catch (error) {
        console.error('Erreur chargement stats:', error);
        addLog('‚ùå Erreur lors du chargement des statistiques');
    }
}

async function loadMarketAnalytics() {
    try {
        const response = await fetch('/api/analytics/market');
        const data = await response.json();
        
        if (data.success) {
            displayMarketAnalytics(data.insights);
        }
        
    } catch (error) {
        console.error('Erreur chargement analytics:', error);
    }
}

function displayMarketAnalytics(insights) {
    // Top technologies
    const techDiv = document.getElementById('topTechnologies');
    if (insights.top_technologies && insights.top_technologies.length > 0) {
        techDiv.innerHTML = insights.top_technologies.slice(0, 5).map(tech => 
            `<div class="d-flex justify-content-between mb-1">
                <span>${tech.name}</span>
                <span class="badge bg-primary">${tech.count}</span>
            </div>`
        ).join('');
    } else {
        techDiv.innerHTML = '<div class="text-muted">Aucune donn√©e disponible</div>';
    }
    
    // Distribution des niveaux d'exp√©rience
    const expDiv = document.getElementById('experienceLevels');
    if (insights.experience_distribution && insights.experience_distribution.length > 0) {
        expDiv.innerHTML = insights.experience_distribution.map(exp => 
            `<div class="d-flex justify-content-between mb-1">
                <span>${exp.level}</span>
                <span class="badge bg-secondary">${exp.count}</span>
            </div>`
        ).join('');
    } else {
        expDiv.innerHTML = '<div class="text-muted">Aucune donn√©e disponible</div>';
    }
    
    // Top entreprises
    const compDiv = document.getElementById('topCompanies');
    if (insights.top_hiring_companies && insights.top_hiring_companies.length > 0) {
        compDiv.innerHTML = insights.top_hiring_companies.slice(0, 5).map(comp => 
            `<div class="d-flex justify-content-between mb-1">
                <span>${comp.name}</span>
                <span class="badge bg-success">${comp.jobs}</span>
            </div>`
        ).join('');
    } else {
        compDiv.innerHTML = '<div class="text-muted">Aucune donn√©e disponible</div>';
    }
    
    // Stats remote
    const remoteDiv = document.getElementById('remoteStats');
    if (insights.remote_percentage !== undefined) {
        remoteDiv.innerHTML = `
            <div class="progress mb-2">
                <div class="progress-bar bg-info" style="width: ${insights.remote_percentage}%"></div>
            </div>
            <small>${insights.remote_percentage}% des offres proposent du remote</small>
        `;
    } else {
        remoteDiv.innerHTML = '<div class="text-muted">Aucune donn√©e disponible</div>';
    }
}

function updateScrapersStatus(data) {
    const statusDiv = document.getElementById('scrapersStatus');
    const scrapers = [
        { name: 'Welcome to the Jungle', id: 'wttj', status: 'active' },
        { name: 'LinkedIn', id: 'linkedin', status: 'development' },
        { name: 'Indeed', id: 'indeed', status: 'development' }
    ];
    
    statusDiv.innerHTML = scrapers.map(scraper => {
        const statusClass = scraper.status === 'active' ? 'success' : 'warning';
        const statusText = scraper.status === 'active' ? 'Actif' : 'En d√©veloppement';
        
        return `
            <div class="d-flex justify-content-between align-items-center mb-2">
                <span>${scraper.name}</span>
                <span class="badge bg-${statusClass}">${statusText}</span>
            </div>
        `;
    }).join('');
}

function addLog(message) {
    const logsDiv = document.getElementById('scrapingLogs');
    const timestamp = new Date().toLocaleTimeString();
    const logEntry = document.createElement('div');
    logEntry.innerHTML = `<span class="text-muted">[${timestamp}]</span> ${message}`;
    logEntry.className = 'mb-1';
    
    logsDiv.appendChild(logEntry);
    logsDiv.scrollTop = logsDiv.scrollHeight;
}

function clearLogs() {
    document.getElementById('scrapingLogs').innerHTML = '<p class="text-muted">Logs effac√©s</p>';
    document.getElementById('realTimeLogs').innerHTML = '<div class="text-muted">Logs effac√©s</div>';
}

function saveConfig() {
    addLog('üíæ Configuration sauvegard√©e');
    
    // Sauvegarder la configuration dans localStorage
    const config = {
        sources: {
            wttj: document.getElementById('wttj').checked,
            linkedin: document.getElementById('linkedin').checked,
            indeed: document.getElementById('indeed').checked
        },
        maxJobs: document.getElementById('maxJobs').value,
        delay: document.getElementById('delay').value
    };
    
    localStorage.setItem('linkedboost_scraping_config', JSON.stringify(config));
    
    // Feedback visuel
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-check me-2"></i>Sauvegard√©!';
    btn.className = 'btn btn-success';
    
    setTimeout(() => {
        btn.innerHTML = originalText;
        btn.className = 'btn btn-primary';
    }, 2000);
}

function loadSavedConfig() {
    /**
     * Charge la configuration sauvegard√©e
     */
    try {
        const saved = localStorage.getItem('linkedboost_scraping_config');
        if (saved) {
            const config = JSON.parse(saved);
            
            // Restaurer les checkboxes
            if (config.sources) {
                document.getElementById('wttj').checked = config.sources.wttj;
                document.getElementById('linkedin').checked = config.sources.linkedin;
                document.getElementById('indeed').checked = config.sources.indeed;
            }
            
            // Restaurer les valeurs num√©riques
            if (config.maxJobs) {
                document.getElementById('maxJobs').value = config.maxJobs;
            }
            if (config.delay) {
                document.getElementById('delay').value = config.delay;
            }
        }
    } catch (error) {
        console.error('Erreur chargement configuration:', error);
    }
}

function refreshStats() {
    addLog('üîÑ Actualisation des statistiques...');
    loadStats();
    loadMarketAnalytics();
    
    // Animation de l'ic√¥ne de refresh
    const btn = event.target.closest('button');
    const icon = btn.querySelector('i');
    icon.classList.add('fa-spin');
    
    setTimeout(() => {
        icon.classList.remove('fa-spin');
        addLog('‚úÖ Statistiques mises √† jour');
    }, 1500);
}

function exportScrapingReport() {
    /**
     * Exporte un rapport de scraping
     */
    const report = {
        timestamp: new Date().toISOString(),
        stats: {
            total_jobs: document.getElementById('totalJobs').textContent,
            last_scrape: document.getElementById('lastScrape').textContent,
            embeddings: document.getElementById('embeddingsCount').textContent,
            errors: document.getElementById('errorCount').textContent
        },
        configuration: {
            max_jobs: document.getElementById('maxJobs').value,
            delay: document.getElementById('delay').value,
            sources: {
                wttj: document.getElementById('wttj').checked,
                linkedin: document.getElementById('linkedin').checked,
                indeed: document.getElementById('indeed').checked
            }
        }
    };
    
    const blob = new Blob([JSON.stringify(report, null, 2)], {
        type: 'application/json'
    });
    
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `linkedboost_scraping_report_${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    addLog('üìä Rapport de scraping export√©');
}

// Gestion des raccourcis clavier
document.addEventListener('keydown', function(event) {
    // Ctrl/Cmd + R pour rafra√Æchir les stats
    if ((event.ctrlKey || event.metaKey) && event.key === 'r') {
        event.preventDefault();
        refreshStats();
    }
    
    // Ctrl/Cmd + S pour sauvegarder la config
    if ((event.ctrlKey || event.metaKey) && event.key === 's') {
        event.preventDefault();
        saveConfig();
    }
    
    // √âchap pour fermer le modal de progression
    if (event.key === 'Escape' && !scrapingInProgress) {
        const modal = bootstrap.Modal.getInstance(document.getElementById('scrapingProgressModal'));
        if (modal) {
            modal.hide();
        }
    }
});

// Auto-refresh toutes les 30 secondes (seulement si pas de scraping en cours)
setInterval(() => {
    if (!scrapingInProgress) {
        loadStats();
    }
}, 30000);

// Charger la config sauvegard√©e au d√©marrage
document.addEventListener('DOMContentLoaded', function() {
    loadSavedConfig();
});

// Gestion de la fermeture de page pendant scraping
window.addEventListener('beforeunload', function(event) {
    if (scrapingInProgress) {
        event.preventDefault();
        event.returnValue = 'Un scraping est en cours. √ätes-vous s√ªr de vouloir quitter ?';
        return event.returnValue;
    }
});

// Notification syst√®me si disponible
function showSystemNotification(title, message) {
    if ('Notification' in window && Notification.permission === 'granted') {
        new Notification(title, {
            body: message,
            icon: '/static/favicon.ico'
        });
    } else if ('Notification' in window && Notification.permission !== 'denied') {
        Notification.requestPermission().then(function(permission) {
            if (permission === 'granted') {
                new Notification(title, {
                    body: message,
                    icon: '/static/favicon.ico'
                });
            }
        });
    }
}

// Ajouter bouton d'export dans le header
function addExportButton() {
    const headerDiv = document.querySelector('.d-flex.justify-content-between.align-items-center');
    const buttonGroup = headerDiv.querySelector('div');
    
    const exportBtn = document.createElement('button');
    exportBtn.className = 'btn btn-outline-primary ms-2';
    exportBtn.innerHTML = '<i class="fas fa-download me-2"></i>Exporter';
    exportBtn.onclick = exportScrapingReport;
    
    buttonGroup.appendChild(exportBtn);
}

// Initialisation suppl√©mentaire au chargement
document.addEventListener('DOMContentLoaded', function() {
    addExportButton();
    
    // Demander permission pour les notifications
    if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission();
    }
    
    console.log('‚úÖ Dashboard de scraping initialis√©');
});

</script>
{% endblock %}